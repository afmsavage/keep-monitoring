:toc: macro

= Keep Network Monitoring System

This repository contains tools for monitoring
https://github.com/keep-network/keep-core[keep-core]
and
https://github.com/keep-network/keep-ecdsa[keep-ecdsa]
clients.

The tools support monitoring of:

- Keep Network clients,

- host machines the clients are working on,

- ethereum accounts balances for Keep Network operators.

The configuration includes pre-defined sets of <<Dashboards>> and <<Alerts>>.

<<Alerts>> integration with <<Slack>> and <<Opsgenie>> is supported.

image::./docs/img/sample.gif[Keep Dashboards Sample GIF,600,link="./docs/img/sample.gif"]

---

:icons: font
:numbered:
toc::[]

== Installation

To install the monitoring system first clone this repository on your machine:

```sh
git clone git@github.com:boar-network/keep-monitoring.git
```

Then, install Docker and Docker Compose and run:

```sh
docker-compose up
```

Containers named `prometheus` and `grafana` will be up and running.

The Grafana dashboard will be accessible on port `8080` (http://localhost:8080/).
Use `admin/admin` credentials when signing in for the first time.

For guidance on setting up nodes to be monitored see <<Monitoring Targets>> section. 

== Dashboards

Installed Grafana instance contains few predefined dashboards:

- `Keep Balances`: contains balances of monitored operators ethereum accounts,

- `Keep Clients`: contains client-level metrics such as
`connected_peers_count` and similar. You can change the observed client
using the `client` dropdown in the top left corner,

- `Keep Systems`: contains system-level metrics such as
CPU and memory usage. You can change the observed system
using the `system` dropdown in the top left corner.

There are also Summary dashboards available, aggregating metrics for all the configured nodes.

image:./docs/img/sample-eth-balances.png[Keep Balances Dashboard Sample,300,link="./docs/img/sample-eth-balances.png"] 
image:./docs/img/sample-keep-clients.png[Keep Clients Dashboard Sample,300,link="./docs/img/sample-keep-clients.png"]
image:./docs/img/sample-keep-systems.png[Keep Systems Dashboard Sample,300,link="./docs/img/sample-keep-systems.png"]

== Alerts

=== Alert rules

Installed Prometheus instance contains several predefined alerts corresponding
to the predefined Grafana dashboards. Those alerts are defined in link:./prometheus/alert-rules.yml[] file. 

Rules reconfiguration requires Prometheus container restart.

Alerts corresponding to the clients:

- `ClientDown`: fired when a client goes down
- `EthConnectivityDown`: fired when a connection with the ethereum node is down
- `LowConnectedPeersCount`: fired when connected peers count falls below `5`
- `LowConnectedBootstrapCount`: fired when connected bootstrap count falls below `2`

Alerts corresponding to the systems:

- `SystemDown`: fired when a system goes down
- `HighCpuUsage`: fired when system CPU usage goes above `90%`
- `HighMemoryUsage`: fired when system memory usage goes above `90%`
- `HighDiskSpaceUsage`: fired when system disk space usage goes above `90%`

Alerts corresponding to the ethereum account balances:

- `LowAccountBalance`: fired when given account's balance falls below `1 ETH`

=== Alert receivers

Alerts are emitted to the receivers configured in link:./alertmanager/alertmanager.yml[].

The configuration defines following pre-defined receivers: <<Slack>>, <<Opsgenie>>.

==== Slack

To use https://slack.com[Slack] notifications, two properties should be set in the
`./alertmanager/alertmanager.yml` config file:

- `receivers.slack_configs.api_url`: should contain an URL of the Slack incoming webhook.
- `receivers.slack_configs.channel`: must be set to the same channel as defined in the webhook configuration.

==== Opsgenie

To use https://www.atlassian.com/software/opsgenie[Opsgenie] notifications, three properties should be set in the
`./alertmanager/alertmanager.yml` config file:

- `receivers.opsgenie_configs.api_key`: should contain API key of the Opsgenie API integration
- `receivers.opsgenie_configs.api_url`: should be set to the correct value
depending on the chosen data center region
- `receivers.opsgenie_configs.responders`: should point to the desired alert responders configured in Opsgenie

== Monitoring Targets

To add new monitoring targets you should first configure target endpoints
and add them to the monitoring system.

=== Target Endpoints Configuration

Several types of target endpoints can be handled by the monitoring system:

- Client-level metrics endpoint
+
To expose client-level metrics endpoint of `keep-core` or `keep-ecdsa`
just make sure the `Metrics.Port` config property is set. Everything else
works out of the box.
+
For further details, here is the list of pull requests introducing
client-level metrics:
+
** https://github.com/keep-network/keep-common/pull/40[Metrics core package in keep-common]
** https://github.com/keep-network/keep-core/pull/1850[Metrics for keep-core]
** https://github.com/keep-network/keep-ecdsa/pull/479[Metrics for keep-ecdsa]
- System-level metrics endpoint
+
Exposing system-level metrics is a little bit harder as it depends on the
platform.
+
For *NIX systems you should use the
https://github.com/prometheus/node_exporter[Node Exporter] tool. Installation
instructions are described https://prometheus.io/docs/guides/node-exporter[here].
+
You can also use the predefined Ansible playbook to install the node exporter
automatically on the target machine and expose it on port `9602` by running:
+
```
ansible-playbook -i <user>@<machine>, -e "ansible_port=<ssh_port>" ./ansible-playbooks/linux-node-exporter.yml
```
- Accounts balances endpoint
+
The accounts balance monitoring component is working out of the box.

=== Ethereum Connection

Ethereum accounts monitoring requires connection to Ethereum API. This can be Geth, Alchemy, Infura or any other service.

Configure `GETH` variable with URL to the Ethereum API in `./balance-exporter/variables.env` file.
(link:./balance-exporter/variables.env.SAMPLE)[Sample file])


=== Adding Targets To The Monitoring System

Adding new monitoring targets depends on their type:

- Client-level metrics endpoint
+
Add the new endpoint address to the `targets` array of
the link:./prometheus/clients-targets.json[] file.
- System-level metrics endpoint
+
Add the new endpoint address to the `targets` array of
the link:./prometheus/systems-targets.json[] file.
- Account balance
+
Add the new account's address to `./balance-exporter/addresses.txt` file.
Use the `name:address` format where `name` is an arbitrary value.
In the case of multiple accounts, put them in separate lines.
(link:./balance-exporter/addresses.txt.SAMPLE)[Sample file])

Prometheus will refresh automatically and you should see the new target
in the dashboard after a while.

---

Tools developed by the https://boar.network/[Boar Network] team with great
contributions from link:https://github.com/lukasz-zimnoch[lukasz-zimnoch] and 
link:https://github.com/nkuba[nkuba].
